#include <check.h>
#include <stdio.h>
#include "decode.h"


static char compressed[] =
  {
    0x1f, 0x8b, 0x08, 0x00,  0x00, 0x00, 0x00, 0x00,
    0x00, 0x03, 0x15, 0xc5,  0xc9, 0x11, 0x00, 0x10,
    0x14, 0x04, 0xd1, 0x6f,  0xdf, 0xc5, 0x20, 0x2a,
    0x29, 0x38, 0x09, 0x9e,  0x08, 0xb4, 0xa9, 0x7a,
    0xd3, 0x73, 0xed, 0xa1,  0xe4, 0x4f, 0x89, 0xe6,
    0x0d, 0x2c, 0x1c, 0x3c,  0x02, 0x22, 0x92, 0x9c,
    0x9b, 0x69, 0x41, 0x45,  0x43, 0xc7, 0x03, 0x64,
    0x1a, 0xe8, 0x81, 0x40,  0x00, 0x00, 0x00
  };

static char uncompressed[] =
  {
    0x56, 0x67, 0x6d, 0x20,  0x01, 0x00, 0x00, 0x00, // 0x00
    0x00, 0x00, 0x01, 0x00,  0x02, 0x00, 0x00, 0x00, // 0x08
    0x03, 0x00, 0x00, 0x00,  0x04, 0x00, 0x00, 0x00, // 0x10
    0x05, 0x00, 0x00, 0x00,  0x06, 0x00, 0x00, 0x00, // 0x18
    0x07, 0x00, 0x00, 0x00,  0x08, 0x00, 0x00, 0x00, // 0x20
    0x09, 0x00, 0xf1, 0xf2,  0x0a, 0x00, 0x00, 0x00, // 0x28
    0x0b, 0x00, 0x00, 0x00,  0x0c, 0x00, 0x00, 0x00, // 0x30
    0x0d, 0x00, 0x00, 0x00,  0x0e, 0x00, 0x00, 0x00 // 0x38
  };



START_TEST(test_file_type_unknown)
{
  const char buffer[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
  };
  int ft = file_type(buffer, sizeof(buffer));
  ck_assert_int_eq(ft, VGM_FT_UNKNOWN);
}

START_TEST(test_file_type_null)
{
  int ft = file_type(NULL, 0);
  ck_assert_int_eq(ft, VGM_FT_UNKNOWN);
}

START_TEST(test_file_type_empty)
{
  int ft = file_type("", 0);
  ck_assert_int_eq(ft, VGM_FT_UNKNOWN);
}

START_TEST(test_file_type_short_1)
{
  int ft = file_type("V", 1);
  ck_assert_int_eq(ft, VGM_FT_UNKNOWN);
}

START_TEST(test_file_type_short_3)
{
  int ft = file_type("Vgm", 3);
  ck_assert_int_eq(ft, VGM_FT_UNKNOWN);
}

START_TEST(test_file_type_vgm)
{
  const char buffer[] = {
    'V', 'g', 'm', ' ',
    0x00, 0x00, 0x00, 0x00
  };
  int ft = file_type(buffer, sizeof(buffer));
  ck_assert_int_eq(ft, VGM_FT_VGM);
}

START_TEST(test_file_type_vgz)
{
  const char buffer[] = {
    0x1f, 0x8b, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00
  };
  int ft = file_type(buffer, sizeof(buffer));
  ck_assert_int_eq(ft, VGM_FT_VGZ);
}

START_TEST(test_decompression)
{
  char *buffer;
  size_t size = decompress(&buffer, compressed, sizeof(compressed));
  ck_assert_uint_eq(size, sizeof(uncompressed));
  int diff = bcmp(buffer, uncompressed, size);
  ck_assert_uint_eq(diff, 0);
}

Suite *make_decode_file_suite(void)
{
  Suite *s = suite_create("Decode");
  TCase *tc_ft = tcase_create("Filetype");
  TCase *tc_z = tcase_create("decompress");

  tcase_add_test(tc_ft, test_file_type_unknown);
  tcase_add_test(tc_ft, test_file_type_null);
  tcase_add_test(tc_ft, test_file_type_empty);
  tcase_add_test(tc_ft, test_file_type_short_1);
  tcase_add_test(tc_ft, test_file_type_short_3);
  tcase_add_test(tc_ft, test_file_type_vgm);

  tcase_add_test(tc_z, test_decompression);

  suite_add_tcase(s, tc_ft);
  suite_add_tcase(s, tc_z);

  return s;
}
